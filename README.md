# Telegram Bot для учёта материальных ценностей

Бот для учёта материальных ценностей малого предприятия: операции прихода, расхода, списания, передачи, возврата и инвентаризации. Данные хранятся в SQLite, с возможностью дублирования в Google Sheets.

---

## Текущее состояние разработки

### Реализовано

- **Окружение и конфигурация** — структура проекта, `config.py`, `.env`/`.env.example`, логирование в файл, создание каталогов `data/`, `logs/`, `credentials/`.
- **Минимальный бот** — запуск через `python -m src.main`, роутеры и заготовки handlers/keyboards, middleware для ролей.
- **БД** — схема (User, Asset, Operation, LogEntry, Category, AssetInstance), инициализация и миграции, DAO для всех сущностей.
- **Регистрация и роли** — первый пользователь становится системным администратором, остальные создаются в статусе «ожидает одобрения». Обработчики `/start`, `/help` с разным текстом для админа и пользователя.
- **Админ-панель** — `/admin`, `/users` (список пользователей), смена ролей через inline-кнопки.
- **Главное меню** — шесть кнопок: Приход, Расход, Списание, Инвентаризация, Передача, Возврат.
- **MVP «Приход имущества»** — полный FSM: название → количество → категория → экземпляры (с фото и ценой по желанию) → код → подтверждение → запись в БД и создание операции типа `incoming`.
- **MVP «Расход имущества»** — выбор актива (по коду или из списка) → получатель → количество → подтверждение → запись операции `outgoing`, уменьшение остатка, уведомление получателю и подтверждение получения (подпись).

Списание, передача, возврат и инвентаризация пока отображаются как заглушки с сообщением «в разработке».

---

## Планируется по завершении проекта

- **Этап 2:** списание с согласованием, ручная инвентаризация, ограничения по ролям, интеграция с Google Sheets (`services/sheets.py`).
- **Этап 3:** автоматическая инвентаризация по расписанию, расширенный аудит и логи, Docker (Dockerfile, docker-compose, инструкции по деплою).

---

## Установка и запуск (разработка)

1. Клонировать репозиторий и перейти в каталог проекта.
2. Создать виртуальное окружение и установить зависимости:

   ```bash
   python -m venv venv
   venv\Scripts\activate   # Windows
   pip install -r requirements.txt
   ```

3. Скопировать образец конфигурации и заполнить переменные:

   ```bash
   copy .env.example .env
   ```

4. В `.env` обязательно указать:
   - `BOT_TOKEN` — токен бота от [@BotFather](https://t.me/BotFather).

   Остальные переменные можно оставить по умолчанию (см. `.env.example`).

5. Запуск бота:

   ```bash
   python -m src.main
   ```

Проверка БД (опционально):

```bash
python -c "from src.services.db import test_db; test_db()"
```

**Состояние склада** — скрипт выводит таблицу активов:

```bash
python scripts/show_warehouse.py
```

**Очистка данных по имуществу** — удаляет активы, экземпляры, операции, возвраты и категории (пользователи не трогаются). Для проверки на чистой базе:

```bash
python scripts/clear_assets_db.py          # с запросом подтверждения
python scripts/clear_assets_db.py --yes    # без запроса
python scripts/clear_assets_db.py --dry-run   # только показать, что будет удалено
```

---

## Переменные окружения (.env)

| Переменная | Описание | Пример |
|------------|----------|--------|
| `BOT_TOKEN` | Токен Telegram-бота | *(обязательно)* |
| `GOOGLE_SHEETS_ID` | ID таблицы Google Sheets | для этапа 2 |
| `GOOGLE_CREDENTIALS_PATH` | Путь к `service_account.json` | `./credentials/service_account.json` |
| `ADMIN_PASSWORD` | Пароль админ-функций | `0000` |
| `BASE_DIR` | Корень проекта | `./` |
| `DB_PATH` | Путь к файлу SQLite | `./data/db.sqlite3` |
| `LOG_PATH` | Путь к логу | `./logs/app.log` |
| `LOG_LEVEL` | Уровень логирования | `DEBUG` |
| `DEV_MODE` | Режим разработки | `true` |
| `USE_WEBHOOK` | Использовать webhook | `false` |
| `MOCK_SHEETS` | Не вызывать API Sheets | `false` |

---

## Роли пользователей

| Роль | Описание |
|------|----------|
| **Системный администратор** | Первый зарегистрированный пользователь; полный доступ, в т.ч. смена ролей. |
| **Менеджер** | Доступ к админ-панели и списку пользователей. |
| **Кладовщик** | Операции прихода, расхода и т.д. |
| **Прораб** | Работа со своими и подчинёнными активами. |
| **Рабочий** | Работа со своим имуществом. |
| **Не зарегистрирован** | Ожидает одобрения администратором; доступ к операциям ограничен. |

---

## Основные команды

- `/start` — регистрация/вход, приветствие и главное меню.
- `/help` — справка по командам (для админа — расширенный список).
- `/admin` — админ-панель (только для администратора и менеджера).
- `/users` — список пользователей и смена ролей (только для админа/менеджера).

Операции также доступны по кнопкам главного меню: Приход, Расход, Списание, Инвентаризация, Передача, Возврат.

---

**Отчёт по скриптам** — описание всех скриптов, что делают и как запускаются: [docs/SCRIPTS.md](docs/SCRIPTS.md).

---

## Структура проекта

```
bot-accounting/
├── src/
│   ├── main.py              # Точка входа
│   ├── config.py            # Конфигурация из .env
│   ├── handlers/            # Обработчики (start, admin, operations, inventory, user_reg)
│   ├── keyboards/           # Клавиатуры (главное меню)
│   ├── services/            # БД (db.py), далее sheets, qr, scheduler
│   ├── middlewares/         # auth.py
│   ├── states/              # FSM (income, outgoing)
│   └── utils/               # logging_config
├── data/                    # SQLite (в .gitignore)
├── logs/                    # Логи (в .gitignore)
├── credentials/             # service_account.json (в .gitignore)
├── docs/                    # Документация (SCRIPTS.md — отчёт по скриптам)
├── docker/                  # Docker (на этапе 3)
├── .env.example
├── requirements.txt
└── README.md
```
