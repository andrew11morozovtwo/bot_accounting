# Поля данных при операции "Приход имущества"

Данный документ описывает все поля данных, которые сохраняются в базу данных при выполнении операции "Приход имущества".

## Таблица `assets` (Активы)

Основная информация об активе (товаре).

| Переменная | Объяснение | Тип | Ограничения | Обязательность |
|------------|------------|-----|-------------|----------------|
| `id` | Уникальный идентификатор актива | Integer | Автоинкремент, Primary Key | Обязательно |
| `name` | Название товара/имущества | String | Макс. 255 символов | Обязательно |
| `category_id` | Идентификатор категории товара | Integer | Foreign Key к `categories.id` | Необязательно (NULL) |
| `code` | Код/артикул товара (QR-код, штрихкод) | String | Макс. 100 символов, уникальный, индексирован | Необязательно (NULL) |
| `owner_user_id` | Идентификатор владельца актива | Integer | Foreign Key к `users.id` | Необязательно (NULL) |
| `qty` | Общее количество единиц товара на складе | Float | По умолчанию 0.0 | Обязательно |
| `price` | Учетная цена за единицу (устаревшее поле) | Float | Необязательно (NULL) | Необязательно (NULL) |
| `state` | Состояние актива | String | Макс. 50 символов, по умолчанию 'in_stock' | Обязательно |
| `created_at` | Дата и время создания записи | DateTime | Автоматически при создании | Обязательно |
| `updated_at` | Дата и время последнего обновления | DateTime | Автоматически при обновлении | Обязательно |

**Примечание:** Поле `price` в таблице `assets` больше не используется. Цена хранится в таблице `asset_instances` для каждого экземпляра отдельно.

---

## Таблица `asset_instances` (Экземпляры активов)

Информация о каждом отдельном экземпляре товара.

| Переменная | Объяснение | Тип | Ограничения | Обязательность |
|------------|------------|-----|-------------|----------------|
| `id` | Уникальный идентификатор экземпляра | Integer | Автоинкремент, Primary Key | Обязательно |
| `asset_id` | Идентификатор актива, к которому относится экземпляр | Integer | Foreign Key к `assets.id`, индексирован | Обязательно |
| `distinctive_features` | Отличительные особенности экземпляра | String | Макс. 255 символов | Обязательно |
| `assigned_to_user_id` | Идентификатор пользователя, которому назначен экземпляр | Integer | Foreign Key к `users.id`, индексирован | Необязательно (NULL) |
| `photo_file_id` | Telegram file_id фотографии экземпляра | String | Макс. 255 символов | Необязательно (NULL) |
| `price` | Учетная цена за единицу для этого экземпляра | Float | Точность до 2 знаков после запятой | Необязательно (NULL) |
| `state` | Состояние экземпляра | String | Макс. 50 символов, по умолчанию 'in_stock' | Обязательно |
| `created_at` | Дата и время создания записи | DateTime | Автоматически при создании | Обязательно |
| `updated_at` | Дата и время последнего обновления | DateTime | Автоматически при обновлении | Обязательно |

**Особенности:**
- `distinctive_features` может содержать:
  - Ручной ввод: "синий", "красный", "Ком2 у бух", "В кор ближе к двери"
  - Автоматическая нумерация: "Экз. #1", "Экз. #2"
- `photo_file_id` заполняется в зависимости от режима фото:
  - **Batch режим:** одно фото для всех экземпляров
  - **Individual режим:** отдельное фото для каждого экземпляра
- `price` заполняется в зависимости от режима фото:
  - **Batch режим:** одна цена для всех экземпляров
  - **Individual режим:** отдельная цена для каждого экземпляра

---

## Таблица `operations` (Операции)

Информация об операции прихода товара на склад.

| Переменная | Объяснение | Тип | Ограничения | Обязательность |
|------------|------------|-----|-------------|----------------|
| `id` | Уникальный идентификатор операции | Integer | Автоинкремент, Primary Key | Обязательно |
| `type` | Тип операции | String | Макс. 50 символов, значение 'incoming' | Обязательно |
| `asset_id` | Идентификатор актива, с которым связана операция | Integer | Foreign Key к `assets.id` | Обязательно |
| `from_user_id` | Идентификатор пользователя-отправителя | Integer | Foreign Key к `users.id` | Необязательно (NULL) |
| `to_user_id` | Идентификатор пользователя-получателя | Integer | Foreign Key к `users.id` | Необязательно (NULL) |
| `qty` | Количество единиц товара в операции | Float | Обязательно | Обязательно |
| `price` | Средняя цена за единицу для этой операции | Float | Точность до 2 знаков после запятой | Необязательно (NULL) |
| `timestamp` | Дата и время выполнения операции | DateTime | Автоматически при создании | Обязательно |
| `comment` | Комментарий к операции | Text | Неограниченная длина | Необязательно (NULL) |
| `photo_file_id` | Telegram file_id фотографии операции | String | Макс. 255 символов | Необязательно (NULL) |

**Особенности:**
- `type` всегда равен `'incoming'` для операций прихода
- `to_user_id` содержит ID пользователя, который выполнил операцию прихода
- `price` рассчитывается как среднее арифметическое цен всех экземпляров в операции
- `photo_file_id` содержит:
  - При batch режиме: фото, загруженное для всей партии
  - При individual режиме: первое доступное фото из экземпляров
- `comment` автоматически заполняется как: "Приход имущества: {название товара}"

---

## Примеры данных

### Пример 1: Batch режим (одна фото и цена на всю партию)

**Таблица `assets`:**
```
name: "Стелаж СТ 08.01 бук"
category_id: 1
code: "Бу"
qty: 1.0
state: "in_stock"
```

**Таблица `asset_instances`:**
```
asset_id: 6
distinctive_features: "Ком2 у бух"
photo_file_id: "AgACAgIAAxkBAAIEcml4dWdpHrQjP9nSjawZiTR5WmNQAAJWDWsbtYzISwYJzlV9xlKfAQADAgADeQADOAQ"
price: 5466.0
state: "in_stock"
```

**Таблица `operations`:**
```
type: "incoming"
asset_id: 6
to_user_id: 1
qty: 1.0
price: 5466.0
comment: "Приход имущества: Стелаж СТ 08.01 бук"
photo_file_id: "AgACAgIAAxkBAAIEcml4dWdpHrQjP9nSjawZiTR5WmNQAAJWDWsbtYzISwYJzlV9xlKfAQADAgADeQADOAQ"
```

### Пример 2: Individual режим (отдельные фото и цены)

**Таблица `assets`:**
```
name: "Шкаф офисный Кд-113 гладкий с полками"
category_id: 1
code: "Серый бу"
qty: 2.0
state: "in_stock"
```

**Таблица `asset_instances` (экземпляр 1):**
```
asset_id: 7
distinctive_features: "В кор ближе к двери"
photo_file_id: "AgACAgIAAxkBAAIEgml4eyiqmGdpSIE3D47O4Xn35LKoAAKVDWsbtYzIS1A35-_P95hRAQADAgADeQADOAQ"
price: 7429.0
state: "in_stock"
```

**Таблица `asset_instances` (экземпляр 2):**
```
asset_id: 7
distinctive_features: "В кор дальше от двери"
photo_file_id: "AgACAgIAAxkBAAIEgml4eyiqmGdpSIE3D47O4Xn35LKoAAKVDWsbtYzIS1A35-_P95hRAQADAgADeQADOAQ"
price: 7429.0
state: "in_stock"
```

**Таблица `operations`:**
```
type: "incoming"
asset_id: 7
to_user_id: 1
qty: 2.0
price: 7429.0  (среднее: (7429.0 + 7429.0) / 2)
comment: "Приход имущества: Шкаф офисный Кд-113 гладкий с полками"
photo_file_id: "AgACAgIAAxkBAAIEgml4eyiqmGdpSIE3D47O4Xn35LKoAAKVDWsbtYzIS1A35-_P95hRAQADAgADeQADOAQ"
```

---

## Связи между таблицами

```
assets (1) ──< (N) asset_instances
  │
  └──< (N) operations
```

- Один актив (`assets`) может иметь множество экземпляров (`asset_instances`)
- Один актив может иметь множество операций (`operations`)
- Каждый экземпляр связан с одним активом
- Каждая операция связана с одним активом
